# Документация A2A Protocol - Официальная спецификация v0.2.2

## Обзор

Эта коллекция Postman реализует полную спецификацию **Agent2Agent (A2A) Protocol v0.2.2** от Google - открытого стандарта для межагентского взаимодействия и совместной работы независимых AI агентов.

## О протоколе A2A

**Agent2Agent (A2A)** - это открытый протокол, разработанный для облегчения коммуникации и взаимодействия между независимыми, потенциально закрытыми системами AI агентов. В экосистеме, где агенты могут быть построены с использованием различных фреймворков, языков или разными поставщиками, A2A предоставляет общий язык и модель взаимодействия.

### Ключевые цели A2A

- **Взаимодействие**: Преодоление коммуникационного разрыва между разнородными агентскими системами
- **Сотрудничество**: Возможность агентов делегировать задачи, обмениваться контекстом и работать вместе над сложными пользовательскими запросами
- **Обнаружение**: Динамическое обнаружение и понимание возможностей других агентов
- **Гибкость**: Поддержка различных режимов взаимодействия
- **Безопасность**: Безопасные коммуникационные паттерны для корпоративных сред
- **Асинхронность**: Нативная поддержка долгосрочных задач и взаимодействий

## Архитектура протокола

### Транспорт и формат

- **Протокол транспорта**: HTTP(S) - обязательно для продакшн-сред
- **Формат данных**: JSON-RPC 2.0 для всех запросов и ответов
- **Потоковая передача**: Server-Sent Events (SSE) для real-time обновлений
- **Content-Type**: `application/json` для JSON-RPC, `text/event-stream` для SSE

### Ключевые компоненты

#### 1. Agent Card (Карта агента)
JSON-документ метаданных, описывающий:
- Идентичность и возможности агента
- URL сервисной точки
- Требования аутентификации
- Поддерживаемые навыки и модальности

Обычно доступна по адресу `/.well-known/agent.json`

#### 2. Task (Задача)
Основная единица работы в A2A:
- Уникальный ID, генерируемый сервером
- Жизненный цикл состояний
- История сообщений
- Артефакты (результаты)

#### 3. Message (Сообщение)
Единичный поворот коммуникации:
- Роль: "user" или "agent"
- Части (Parts) с контентом
- Метаданные и расширения

#### 4. Part (Часть)
Элементарная единица контента:
- **TextPart**: Текстовый контент
- **FilePart**: Файловый контент (base64 или URI)
- **DataPart**: Структурированные JSON данные

#### 5. Artifact (Артефакт)
Результат работы агента:
- Неизменяемые выходные данные
- Составлен из одной или нескольких частей
- Может передаваться инкрементально

## Настройка коллекции

### Переменные коллекции

Установите следующие переменные в Postman:

| Переменная | Описание | Пример |
|------------|----------|---------|
| `baseUrl` | Базовый URL A2A сервера | `https://localhost:10004` |
| `authToken` | Токен аутентификации | `eyJhbGciOiJIUzI1NiIs...` |
| `taskId` | ID задачи для операций | `uuid-задачи` |

### Аутентификация

A2A поддерживает стандартные схемы аутентификации:
- **Bearer Token**: OAuth 2.0 токены
- **API Key**: Статические API ключи
- **Basic Auth**: Базовая аутентификация
- **OpenID Connect**: OIDC токены

Схемы аутентификации объявляются в Agent Card в поле `securitySchemes`.

## Использование коллекции

### 1. Обнаружение агентов

#### Получение публичной Agent Card
```http
GET /.well-known/agent.json
```

Возвращает метаданные агента включая:
- Возможности (`capabilities`)
- Навыки (`skills`)
- Схемы безопасности (`securitySchemes`)
- Поддерживаемые модальности

#### Получение расширенной Agent Card (аутентифицированной)
```http
GET /agent/authenticatedExtendedCard
Authorization: Bearer {token}
```

Доступна только если `supportsAuthenticatedExtendedCard: true`.

### 2. Операции с сообщениями

#### Отправка сообщения (без потоковой передачи)
```json
{
  "jsonrpc": "2.0",
  "id": "uuid",
  "method": "message/send",
  "params": {
    "message": {
      "role": "user",
      "parts": [
        {
          "kind": "text",
          "text": "Привет! Расскажи мне шутку."
        }
      ],
      "messageId": "uuid",
      "kind": "message"
    },
    "configuration": {
      "acceptedOutputModes": ["text/plain", "application/json"],
      "historyLength": 5,
      "blocking": true
    }
  }
}
```

#### Отправка потокового сообщения (SSE)
```json
{
  "jsonrpc": "2.0", 
  "id": "uuid",
  "method": "message/stream",
  "params": {
    "message": {
      "role": "user",
      "parts": [
        {
          "kind": "text",
          "text": "Напиши длинную статью об ИИ."
        }
      ],
      "messageId": "uuid",
      "kind": "message"
    }
  }
}
```

Ответ: `Content-Type: text/event-stream` с потоком SSE событий.

### 3. Управление задачами

#### Получение статуса задачи
```json
{
  "jsonrpc": "2.0",
  "id": "uuid", 
  "method": "tasks/get",
  "params": {
    "id": "task-id",
    "historyLength": 10
  }
}
```

#### Отмена задачи
```json
{
  "jsonrpc": "2.0",
  "id": "uuid",
  "method": "tasks/cancel", 
  "params": {
    "id": "task-id"
  }
}
```

#### Переподписка на поток задачи
```json
{
  "jsonrpc": "2.0",
  "id": "uuid",
  "method": "tasks/resubscribe",
  "params": {
    "id": "task-id"
  }
}
```

### 4. Push-уведомления

#### Настройка push-уведомлений
```json
{
  "jsonrpc": "2.0",
  "id": "uuid",
  "method": "tasks/pushNotificationConfig/set",
  "params": {
    "taskId": "task-id",
    "pushNotificationConfig": {
      "url": "https://client.example.com/webhook/a2a-notifications",
      "token": "secure-client-token",
      "authentication": {
        "schemes": ["Bearer"]
      }
    }
  }
}
```

#### Получение конфигурации push-уведомлений
```json
{
  "jsonrpc": "2.0",
  "id": "uuid", 
  "method": "tasks/pushNotificationConfig/get",
  "params": {
    "id": "task-id"
  }
}
```

## Жизненный цикл задач

### Состояния задач

| Состояние | Описание | Терминальное |
|-----------|----------|--------------|
| `submitted` | Задача получена и подтверждена | Нет |
| `working` | Задача активно обрабатывается | Нет |
| `input-required` | Требуется дополнительный ввод | Нет (пауза) |
| `auth-required` | Требуется дополнительная аутентификация | Нет (пауза) |
| `completed` | Задача успешно завершена | Да |
| `failed` | Задача завершена с ошибкой | Да |
| `canceled` | Задача отменена | Да |
| `rejected` | Задача отклонена агентом | Да |
| `unknown` | Состояние неопределено | Да |

### Типичный поток

1. **Обнаружение**: Клиент получает Agent Card
2. **Инициация**: Отправка `message/send` или `message/stream`
3. **Обработка**: Агент обрабатывает задачу
4. **Взаимодействие**: Опционально - многоступенчатый диалог
5. **Завершение**: Достижение терминального состояния

## Примеры использования

### Простой запрос
```http
POST /
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "message/send", 
  "params": {
    "message": {
      "role": "user",
      "parts": [{"kind": "text", "text": "Расскажи шутку"}],
      "messageId": "uuid",
      "kind": "message"
    }
  }
}
```

### Отправка файла
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "message/send",
  "params": {
    "message": {
      "role": "user", 
      "parts": [
        {
          "kind": "text",
          "text": "Проанализируй это изображение"
        },
        {
          "kind": "file",
          "file": {
            "name": "image.png",
            "mimeType": "image/png", 
            "bytes": "base64-encoded-data"
          }
        }
      ],
      "messageId": "uuid",
      "kind": "message"
    }
  }
}
```

### Многоступенчатое взаимодействие
```json
// Шаг 1: Первоначальный запрос
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "message/send",
  "params": {
    "message": {
      "role": "user",
      "parts": [{"kind": "text", "text": "Забронируй рейс"}],
      "messageId": "uuid1",
      "kind": "message"
    }
  }
}

// Ответ: state: "input-required"

// Шаг 2: Предоставление деталей
{
  "jsonrpc": "2.0", 
  "id": 2,
  "method": "message/send",
  "params": {
    "message": {
      "role": "user",
      "parts": [{"kind": "text", "text": "Москва-Лондон, 10-17 октября"}],
      "contextId": "context-id",
      "taskId": "task-id", 
      "messageId": "uuid2",
      "kind": "message"
    }
  }
}
```

## Обработка ошибок

### Стандартные JSON-RPC ошибки

| Код | Описание |
|-----|----------|
| -32700 | Parse error - Некорректный JSON |
| -32600 | Invalid Request - Некорректный JSON-RPC запрос |
| -32601 | Method not found - Метод не найден |
| -32602 | Invalid params - Некорректные параметры |
| -32603 | Internal error - Внутренняя ошибка сервера |

### A2A-специфичные ошибки

| Код | Ошибка | Описание |
|-----|--------|----------|
| -32001 | TaskNotFoundError | Задача не найдена |
| -32002 | TaskNotCancelableError | Задача не может быть отменена |
| -32003 | PushNotificationNotSupportedError | Push-уведомления не поддерживаются |
| -32004 | UnsupportedOperationError | Операция не поддерживается |
| -32005 | ContentTypeNotSupportedError | Тип контента не поддерживается |
| -32006 | InvalidAgentResponseError | Некорректный ответ агента |

## Продвинутые возможности

### Потоковая передача (SSE)

Для долгосрочных задач используйте `message/stream`:
- Получайте события `TaskStatusUpdateEvent`
- Получайте события `TaskArtifactUpdateEvent`
- Обрабатывайте инкрементальные обновления

### Push-уведомления

Для отключенных или фоновых сценариев:
- Настройте webhook URL
- Получайте асинхронные обновления
- Аутентифицируйте входящие уведомления

### Мультимодальность

A2A поддерживает обмен разнообразными типами контента:
- Текст (TextPart)
- Файлы (FilePart) - inline base64 или URI
- Структурированные данные (DataPart)
- Будущая поддержка аудио/видео

## Безопасность

### Рекомендации по безопасности

1. **Всегда используйте HTTPS** в продакшн-средах
2. **Проверяйте сертификаты TLS** удаленных агентов
3. **Используйте современные схемы аутентификации** (OAuth 2.0, JWT)
4. **Валидируйте входящие данные** и метаданные
5. **Применяйте принцип минимальных привилегий**
6. **Логируйте и мониторьте** межагентские взаимодействия

### Управление учетными данными

- Получайте учетные данные **вне диапазона** A2A протокола
- Передавайте токены через HTTP заголовки
- Не включайте секреты в Agent Cards
- Используйте динамические токены там, где возможно

## Тестирование

### Основные тесты

Коллекция включает автоматические тесты для:
- Проверки статус-кодов ответов
- Валидации структуры JSON-RPC
- Извлечения taskId из ответов
- Обработки ошибок

### Тестовые сценарии

1. **Обнаружение агентов** - получение Agent Cards
2. **Основные сообщения** - текстовые запросы и ответы
3. **Мультимодальность** - файлы и структурированные данные
4. **Управление задачами** - жизненный цикл задач
5. **Обработка ошибок** - различные сценарии ошибок

## Устранение неполадок

### Общие проблемы

**Ошибка 401/403**: Проверьте токены аутентификации и схемы безопасности в Agent Card

**Ошибка 404**: Убедитесь, что baseUrl корректен и агент запущен

**Ошибка -32601**: Метод не поддерживается - проверьте возможности в Agent Card

**Ошибка -32001**: Task не найден - проверьте taskId или создайте новую задачу

**Timeout при потоковой передаче**: Проверьте поддержку streaming в capabilities

### Отладка

1. **Проверьте Agent Card** на наличие поддерживаемых методов
2. **Валидируйте JSON-RPC** структуру запросов
3. **Мониторьте логи** для detailed error messages
4. **Тестируйте аутентификацию** отдельно от бизнес-логики

## Ссылки

- **Официальная спецификация**: https://google-a2a.github.io/A2A/latest/specification/
- **GitHub репозиторий**: https://github.com/google-a2a/A2A
- **Ключевые концепции**: https://google-a2a.github.io/A2A/topics/key-concepts/
- **Руководство разработчика**: https://google-a2a.github.io/A2A/topics/
- **Примеры интеграции**: https://github.com/google-a2a/A2A/tree/main/samples

---

Эта коллекция предоставляет полную реализацию спецификации A2A v0.2.2 для тестирования и интеграции с A2A-совместимыми агентами. Используйте её как отправную точку для разработки своих мультиагентских решений. 